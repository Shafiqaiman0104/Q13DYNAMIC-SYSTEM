<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --warning-color: #f72585;
            --info-color: #7209b7;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark-color);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo i {
            font-size: 2.2rem;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background-color: white;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
        }

        .tab {
            flex: 1;
            padding: 1.2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: rgba(67, 97, 238, 0.1);
        }

        .tab i {
            margin-right: 8px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.8rem 1.5rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border-left: 5px solid var(--primary-color);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.total-orders {
            border-left-color: var(--primary-color);
        }

        .stat-card.total-agents {
            border-left-color: var(--info-color);
        }

        .stat-card.total-products {
            border-left-color: var(--success-color);
        }

        .stat-card.total-revenue {
            border-left-color: var(--warning-color);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }

        .stat-icon.total-orders {
            background-color: var(--primary-color);
        }

        .stat-icon.total-agents {
            background-color: var(--info-color);
        }

        .stat-icon.total-products {
            background-color: var(--success-color);
        }

        .stat-icon.total-revenue {
            background-color: var(--warning-color);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 1rem;
            color: var(--gray-color);
            font-weight: 500;
        }

        .stat-change {
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive {
            color: #28a745;
        }

        .stat-change.negative {
            color: #dc3545;
        }

        /* Data Tables */
        .data-table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .data-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .data-table tr:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .status {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }

        .status.paid, .status.delivered {
            background-color: rgba(40, 167, 69, 0.15);
            color: #28a745;
        }

        .status.pending {
            background-color: rgba(255, 193, 7, 0.15);
            color: #ffc107;
        }

        .status.cancelled {
            background-color: rgba(220, 53, 69, 0.15);
            color: #dc3545;
        }

        .action-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            margin-right: 5px;
            font-size: 0.85rem;
        }

        .action-btn:hover {
            background-color: var(--secondary-color);
        }

        .action-btn.edit {
            background-color: #17a2b8;
        }

        .action-btn.delete {
            background-color: #dc3545;
        }

        /* Chart Container */
        .chart-container {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        /* Filters and Search */
        .filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.5rem;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-color);
        }

        .filter-select {
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 1rem;
            background-color: white;
            min-width: 150px;
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(67, 97, 238, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid #f5c6cb;
            margin-bottom: 1rem;
            display: none;
        }

        /* Compact view for smaller screens */
        .compact-text {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Mobile Responsive */
        @media (max-width: 992px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
.form-row {
        grid-template-columns: 1fr; /* Single column on mobile */
    }
    .modal-content {
        margin: 2% auto; /* Reduce top/bottom margin */
        padding: 1.5rem; /* Reduce padding */
        width: 95%; /* Make it wider on mobile */
        max-height: 90vh; /* Allow more height on mobile */
    }
    /* Make form rows single column on mobile */
    .form-row {
        grid-template-columns: 1fr; /* Single column on mobile */
    }
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                flex: 1 0 calc(50% - 4px);
                padding: 1rem 0.5rem;
            }

            .tab-content {
                padding: 1.5rem 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 1.5rem 1rem;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box, .filter-select {
                width: 100%;
            }
        }

        @media (max-width: 576px) {
            .tab {
                flex: 1 0 100%;
            }

            .logo h1 {
                font-size: 1.5rem;
            }

            .stat-value {
                font-size: 1.8rem;
            }
        }

    /* Reduce padding on smaller mobile screens */
    @media (max-width: 480px) {
        .modal-content {
            padding: 1rem;
            margin: 1% auto;
        }
        
        .modal-header {
            margin-bottom: 1rem;
            padding-bottom: 0.8rem;
        }
        
        .form-group {
            margin-bottom: 0.8rem;
        }
        
        .form-actions {
            margin-top: 1rem;
            padding-top: 1rem;
        }
        
        .btn {
            padding: 0.7rem 1.2rem;
        }
    }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            max-height: 85vh; /* Limit height to 85% of viewport */
            box-shadow: var(--box-shadow);
            animation: slideIn 0.3s ease;
            overflow-y: auto; /* Make it scrollable */
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-color);
            transition: var(--transition);
        }

        .close-btn:hover {
            color: var(--dark-color);
        }

        .form-group {
    margin-bottom: 1rem;
}


        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-input {
    width: 100%;
    padding: 0.8rem;
    border: 1px solid #ddd;
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: var(--transition);
}

        .form-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
}

     .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}


        .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #dee2e6;
}

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .url-preview {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: var(--gray-color);
            word-break: break-all;
        }

        .url-preview a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .url-preview a:hover {
            text-decoration: underline;
        }
/* Add Product Form Styles */
.add-product-form {
    background-color: #f8f9fa;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 2px dashed #dee2e6;
    display: none; /* Hidden by default */
}

.add-product-form.active {
    display: block;
}
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <h1>Admin Dashboard</h1>
                </div>
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <div>
                        <h3>Administrator</h3>
                        <p>admin@example.com</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Error Message Area -->
        <div class="error-message" id="error-message">
            <strong>Error:</strong> <span id="error-text"></span>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>
            <div class="tab" data-tab="orders">
                <i class="fas fa-shopping-cart"></i> Customer Orders
            </div>
<div class="tab" data-tab="sales-commission">
        <i class="fas fa-chart-bar"></i> Sales & Commission
    </div>
            <div class="tab" data-tab="agents">
                <i class="fas fa-users"></i> Agents
            </div>
            <div class="tab" data-tab="products">
                <i class="fas fa-box"></i> Products
            </div>
<!-- Add this tab right after the Products tab -->
<div class="tab" data-tab="suppliers">
    <i class="fas fa-truck"></i> Supplier Database
</div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card total-orders">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="total-orders">0</div>
                            <div class="stat-label">Total Orders</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 12% from last month
                            </div>
                        </div>
                        <div class="stat-icon total-orders">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card total-agents">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="total-agents">0</div>
                            <div class="stat-label">Total Agents</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 5% from last month
                            </div>
                        </div>
                        <div class="stat-icon total-agents">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card total-products">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="total-products">0</div>
                            <div class="stat-label">Total Products</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 8% from last month
                            </div>
                        </div>
                        <div class="stat-icon total-products">
                            <i class="fas fa-box"></i>
                        </div>
                    </div>
                </div>

                <div class="stat-card total-revenue">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="total-revenue">RM 0</div>
                            <div class="stat-label">Total Revenue</div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 15% from last month
                            </div>
                        </div>
                        <div class="stat-icon total-revenue">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Orders Overview</h3>
                    <select class="filter-select" id="chart-period">
                        <option value="week">Last 7 Days</option>
                        <option value="month">Last 30 Days</option>
                        <option value="quarter">Last 3 Months</option>
                    </select>
                </div>
                <canvas id="ordersChart"></canvas>
            </div>
        </div>

        <!-- Customer Orders Tab -->
        <div id="orders" class="tab-content">
            <div class="filters">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="order-search" placeholder="Search orders by name, phone, email, or bill code...">
                </div>
                <div>
                    <select class="filter-select" id="order-status-filter">
                        <option value="all">All Statuses</option>
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                    </select>
                    <select class="filter-select" id="order-delivery-filter">
                        <option value="all">All Delivery Status</option>
                        <option value="delivered">Delivered</option>
                        <option value="pending">Pending</option>
                        <option value="notice">Notice</option>
                        <option value="packing">Packing</option>
                        <option value="on delivery">On Delivery</option>
                        <option value="complete">Complete</option>
                    </select>
                </div>
            </div>

            <div class="data-table-container">
                <div class="loading" id="orders-loading">
                    <div class="spinner"></div>
                    <p>Loading orders data...</p>
                </div>
                <table class="data-table" id="orders-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Address</th>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Postage</th>
                            <th>Note</th>
                            <th>Discount Code</th>
                            <th>Spin Prize</th>
                            <th>Total</th>
                            <th>Payment</th>
                            <th>Bill Code</th>
                            <th>Delivery</th>
                            <th>UserId</th>
                            <th>Remark</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body">
                        <!-- Orders data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Agents Tab -->
        <div id="agents" class="tab-content">
            <div class="filters">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="agent-search" placeholder="Search agents by name, phone, or email...">
                </div>
                <button class="action-btn" id="add-agent-btn">
                    <i class="fas fa-plus"></i> Add Agent
                </button>
            </div>

            <div class="data-table-container">
                <div class="loading" id="agents-loading">
                    <div class="spinner"></div>
                    <p>Loading agents data...</p>
                </div>
                <table class="data-table" id="agents-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Agent ID</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Address</th>
                            <th>Timestamp</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="agents-table-body">
                        <!-- Agents data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

<!-- Products Tab -->
<div id="products" class="tab-content">
    <div class="filters">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="product-search" placeholder="Search products by name, code, or style...">
        </div>
        <button class="action-btn" id="add-product-btn">
            <i class="fas fa-plus"></i> Add Product
        </button>
    </div>

    <!-- Add Product Form -->
    <div class="add-product-form" id="addProductForm">
        <h3 style="margin-bottom: 1.5rem; color: var(--primary-color);">
            <i class="fas fa-plus-circle"></i> Add New Product
        </h3>
        <form id="addProductFormFields">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="add-code">Product Code *</label>
                    <input type="text" class="form-input" id="add-code" name="code" required 
                           placeholder="e.g., PROD001">
                </div>
                <div class="form-group">
                    <label class="form-label" for="add-name">Product Name *</label>
                    <input type="text" class="form-input" id="add-name" name="name" required 
                           placeholder="e.g., Luxury Watch">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="add-shot">Shot Count</label>
                    <input type="number" class="form-input" id="add-shot" name="shot" 
                           min="0" placeholder="e.g., 100">
                </div>
                <div class="form-group">
                    <label class="form-label" for="add-style">Style</label>
                    <select class="form-input" id="add-style" name="style">
                        <option value="">Select Style</option>
                        <option value="S">S</option>
                        <option value="V">V</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="add-inch">Inch</label>
                    <input type="number" class="form-input" id="add-inch" name="inch" 
                           step="0.1" min="0" placeholder="e.g., 5.5">
                </div>
                <div class="form-group">
                    <label class="form-label" for="add-duration">Duration</label>
                    <input type="text" class="form-input" id="add-duration" name="duration" 
                           placeholder="e.g., 00:52">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="add-postage">Postage Fee (RM)</label>
                    <input type="number" class="form-input" id="add-postage" name="postage" 
                           step="0.01" min="0" value="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label" for="add-price">Price (RM) *</label>
                    <input type="number" class="form-input" id="add-price" name="price" 
                           step="0.01" min="0" required placeholder="0.00">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="add-image">Image URL</label>
                <input type="url" class="form-input" id="add-image" name="image" 
                       placeholder="https://example.com/image.jpg">
                <div class="url-preview" id="add-image-preview"></div>
            </div>

            <div class="form-group">
                <label class="form-label" for="add-video">Video URL</label>
                <input type="url" class="form-input" id="add-video" name="video" 
                       placeholder="https://example.com/video.mp4">
                <div class="url-preview" id="add-video-preview"></div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancel-add-product">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Product
                </button>
            </div>
        </form>
    </div>

    <div class="data-table-container">
        <div class="loading" id="products-loading">
            <div class="spinner"></div>
            <p>Loading products data...</p>
        </div>
        <table class="data-table" id="products-table" style="display: none;">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Shot</th>
                    <th>Style</th>
                    <th>Inch</th>
                    <th>Duration</th>
                    <th>Postage</th>
                    <th>Price</th>
                    <th>Image</th>
                    <th>Video</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="products-table-body">
                <!-- Products data will be populated here -->
            </tbody>
        </table>
    </div>
</div> 

<!-- Supplier Database Tab -->
<div id="suppliers" class="tab-content">
    <div class="filters">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="supplier-search" placeholder="Search suppliers by name, code, or style...">
        </div>
        <button class="action-btn" id="add-supplier-btn">
            <i class="fas fa-plus"></i> Add Supplier Product
        </button>
    </div>

    <!-- Add Supplier Product Form -->
    <div class="add-product-form" id="addSupplierForm">
        <h3 style="margin-bottom: 1.5rem; color: var(--primary-color);">
            <i class="fas fa-plus-circle"></i> Add New Supplier Product
        </h3>
        <form id="addSupplierFormFields">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="add-supplier-code">Product Code *</label>
                    <input type="text" class="form-input" id="add-supplier-code" name="supplier_code" required 
                           placeholder="e.g., SUP001">
                </div>
                <div class="form-group">
                    <label class="form-label" for="add-supplier-name">Product Name *</label>
                    <input type="text" class="form-input" id="add-supplier-name" name="supplier_name" required 
                           placeholder="e.g., Luxury Watch Supplier">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="add-supplier-shot">Shot Count</label>
                    <input type="number" class="form-input" id="add-supplier-shot" name="supplier_shot" 
                           min="0" placeholder="e.g., 100">
                </div>
                <div class="form-group">
                    <label class="form-label" for="add-supplier-style">Style</label>
                    <select class="form-input" id="add-supplier-style" name="supplier_style">
                        <option value="">Select Style</option>
                        <option value="S">S</option>
                        <option value="V">V</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="add-supplier-inch">Inch</label>
                    <input type="number" class="form-input" id="add-supplier-inch" name="supplier_inch" 
                           step="0.1" min="0" placeholder="e.g., 5.5">
                </div>
                <div class="form-group">
                    <label class="form-label" for="add-supplier-duration">Duration</label>
                    <input type="text" class="form-input" id="add-supplier-duration" name="supplier_duration" 
                           placeholder="e.g., 00:52">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="add-supplier-postage">Postage Fee (RM)</label>
                    <input type="number" class="form-input" id="add-supplier-postage" name="supplier_postage" 
                           step="0.01" min="0" value="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label" for="add-supplier-rm_supplier">Rm (Supplier)</label>
                    <input type="number" class="form-input" id="add-supplier-rm_supplier" name="supplier_rm_supplier" 
                           step="0.01" min="0" placeholder="0.00">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="add-supplier-rm_agent">Rm (Agent)</label>
                    <input type="number" class="form-input" id="add-supplier-rm_agent" name="supplier_rm_agent" 
                           step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label" for="add-supplier-rm_market">Rm (Market)</label>
                    <input type="number" class="form-input" id="add-supplier-rm_market" name="supplier_rm_market" 
                           step="0.01" min="0" placeholder="0.00">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="add-supplier-profit_direct_supplier">Profit (Direct Supplier)</label>
                    <input type="number" class="form-input" id="add-supplier-profit_direct_supplier" name="supplier_profit_direct_supplier" 
                           step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label" for="add-supplier-profit_agent">Profit (Agent)</label>
                    <input type="number" class="form-input" id="add-supplier-profit_agent" name="supplier_profit_agent" 
                           step="0.01" min="0" placeholder="0.00">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="add-supplier-profit_from_agent">Profit (From Agent)</label>
                    <input type="number" class="form-input" id="add-supplier-profit_from_agent" name="supplier_profit_from_agent" 
                           step="0.01" min="0" placeholder="0.00">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="add-supplier-image">Image URL</label>
                <input type="url" class="form-input" id="add-supplier-image" name="supplier_image" 
                       placeholder="https://example.com/image.jpg">
                <div class="url-preview" id="add-supplier-image-preview"></div>
            </div>

            <div class="form-group">
                <label class="form-label" for="add-supplier-video">Video URL</label>
                <input type="url" class="form-input" id="add-supplier-video" name="supplier_video" 
                       placeholder="https://example.com/video.mp4">
                <div class="url-preview" id="add-supplier-video-preview"></div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancel-add-supplier">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Supplier Product
                </button>
            </div>
        </form>
    </div>

    <div class="data-table-container">
        <div class="loading" id="suppliers-loading">
            <div class="spinner"></div>
            <p>Loading supplier data...</p>
        </div>
        <table class="data-table" id="suppliers-table" style="display: none;">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Name</th>
                    <th>Shot</th>
                    <th>Style</th>
                    <th>Inch</th>
                    <th>Duration</th>
                    <th>Postage</th>
                    <th>Rm (Supplier)</th>
                    <th>Rm (Agent)</th>
                    <th>Rm (Market)</th>
                    <th>Profit (Direct Supplier)</th>
                    <th>Profit (Agent)</th>
                    <th>Profit (From Agent)</th>
                    <th>Image</th>
                    <th>Video</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="suppliers-table-body">
                <!-- Supplier data will be populated here -->
            </tbody>
        </table>
    </div>
</div>  

<!-- Sales & Commission Tab -->
<div id="sales-commission" class="tab-content">
    <div class="filters">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="sales-search" placeholder="Search by UserId...">
        </div>
        <div>
            <button class="action-btn" id="refresh-sales-btn">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
            <button class="action-btn" id="export-sales-btn">
                <i class="fas fa-download"></i> Export to CSV
            </button>
        </div>
    </div>

    <div class="data-table-container">
        <div class="loading" id="sales-loading">
            <div class="spinner"></div>
            <p>Loading sales and commission data...</p>
        </div>
        <table class="data-table" id="sales-table" style="display: none;">
            <thead>
                <tr>
                    <th>User ID</th>
                    <th>Total Orders</th>
                    <th>Total Qty Product</th>
                    <th>Total Postage (RM)</th>
                    <th>Total Discount Code (RM)</th>
                    <th>Total Spin Prize (RM)</th>
                    <th>Total Price (RM)</th>
                    <th>Total Commission (RM)</th>
                    <th>Total Supplier (RM)</th>
                    <th>Total Profit (RM)</th>
                </tr>
            </thead>
            <tbody id="sales-table-body">
                <!-- Sales data will be populated here -->
            </tbody>
        </table>
    </div>
</div>    

        <!-- Edit Product Modal -->
        <div id="editProductModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Product</h3>
                    <button class="close-btn" onclick="closeEditModal()">&times;</button>
                </div>
                <form id="editProductForm">
                    <input type="hidden" id="edit-product-code" name="code">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="edit-name">Product Name *</label>
                            <input type="text" class="form-input" id="edit-name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-shot">Shot Count</label>
                            <input type="number" class="form-input" id="edit-shot" name="shot" min="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="edit-style">Style</label>
                            <select class="form-input" id="edit-style" name="style">
                                <option value="S">S</option>
                                <option value="V">V</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-inch">Inch</label>
                            <input type="number" class="form-input" id="edit-inch" name="inch" step="0.1" min="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="edit-duration">Duration</label>
                            <input type="text" class="form-input" id="edit-duration" name="duration" placeholder="e.g., 00:52">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-postage">Postage Fee (RM)</label>
                            <input type="number" class="form-input" id="edit-postage" name="postage" step="0.01" min="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="edit-price">Price (RM)</label>
                            <input type="number" class="form-input" id="edit-price" name="price" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="edit-code">Product Code *</label>
                            <input type="text" class="form-input" id="edit-code" name="code" required disabled>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-image">Image URL</label>
                        <input type="url" class="form-input" id="edit-image" name="image" placeholder="https://example.com/image.jpg">
                        <div class="url-preview" id="image-preview"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-video">Video URL</label>
                        <input type="url" class="form-input" id="edit-video" name="video" placeholder="https://example.com/video.mp4">
                        <div class="url-preview" id="video-preview"></div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Product</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="deleteProductModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Delete Product</h3>
                    <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
                </div>
                <div class="form-group">
                    <p id="delete-confirm-text">Are you sure you want to delete this product?</p>
                    <input type="hidden" id="delete-product-code">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteProduct()">Delete Product</button>
                </div>
            </div>
        </div>

<!-- Edit Supplier Modal -->
<div id="editSupplierModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Supplier Product</h3>
            <button class="close-btn" onclick="closeEditSupplierModal()">&times;</button>
        </div>
        <form id="editSupplierForm">
            <input type="hidden" id="edit-supplier-code" name="supplier_code">
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-name">Product Name *</label>
                    <input type="text" class="form-input" id="edit-supplier-name" name="supplier_name" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-shot">Shot Count</label>
                    <input type="number" class="form-input" id="edit-supplier-shot" name="supplier_shot" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-style">Style</label>
                    <select class="form-input" id="edit-supplier-style" name="supplier_style">
                        <option value="S">S</option>
                        <option value="V">V</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-inch">Inch</label>
                    <input type="number" class="form-input" id="edit-supplier-inch" name="supplier_inch" step="0.1" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-duration">Duration</label>
                    <input type="text" class="form-input" id="edit-supplier-duration" name="supplier_duration" placeholder="e.g., 00:52">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-postage">Postage Fee (RM)</label>
                    <input type="number" class="form-input" id="edit-supplier-postage" name="supplier_postage" step="0.01" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-rm_supplier">Rm (Supplier)</label>
                    <input type="number" class="form-input" id="edit-supplier-rm_supplier" name="supplier_rm_supplier" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-rm_agent">Rm (Agent)</label>
                    <input type="number" class="form-input" id="edit-supplier-rm_agent" name="supplier_rm_agent" step="0.01" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-rm_market">Rm (Market)</label>
                    <input type="number" class="form-input" id="edit-supplier-rm_market" name="supplier_rm_market" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-profit_direct_supplier">Profit (Direct Supplier)</label>
                    <input type="number" class="form-input" id="edit-supplier-profit_direct_supplier" name="supplier_profit_direct_supplier" step="0.01" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-profit_agent">Profit (Agent)</label>
                    <input type="number" class="form-input" id="edit-supplier-profit_agent" name="supplier_profit_agent" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-profit_from_agent">Profit (From Agent)</label>
                    <input type="number" class="form-input" id="edit-supplier-profit_from_agent" name="supplier_profit_from_agent" step="0.01" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-supplier-code-display">Product Code *</label>
                    <input type="text" class="form-input" id="edit-supplier-code-display" name="supplier_code_display" required disabled>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="edit-supplier-image">Image URL</label>
                <input type="url" class="form-input" id="edit-supplier-image" name="supplier_image" placeholder="https://example.com/image.jpg">
                <div class="url-preview" id="edit-supplier-image-preview"></div>
            </div>

            <div class="form-group">
                <label class="form-label" for="edit-supplier-video">Video URL</label>
                <input type="url" class="form-input" id="edit-supplier-video" name="supplier_video" placeholder="https://example.com/video.mp4">
                <div class="url-preview" id="edit-supplier-video-preview"></div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEditSupplierModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Supplier Product</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Supplier Confirmation Modal -->
<div id="deleteSupplierModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Delete Supplier Product</h3>
            <button class="close-btn" onclick="closeDeleteSupplierModal()">&times;</button>
        </div>
        <div class="form-group">
            <p id="delete-supplier-confirm-text">Are you sure you want to delete this supplier product?</p>
            <input type="hidden" id="delete-supplier-code">
        </div>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteSupplierModal()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteSupplier()">Delete Supplier Product</button>
        </div>
    </div>
</div>

<!-- Add Agent Modal -->
<div id="addAgentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add New Agent</h3>
            <button class="close-btn" onclick="closeAddAgentModal()">&times;</button>
        </div>
        <form id="addAgentForm">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="new-agent-id">Agent ID *</label>
                    <input type="text" class="form-input" id="new-agent-id" name="agentId" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="new-agent-name">Name *</label>
                    <input type="text" class="form-input" id="new-agent-name" name="name" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="new-agent-phone">Phone *</label>
                    <input type="tel" class="form-input" id="new-agent-phone" name="phone" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="new-agent-email">Email *</label>
                    <input type="email" class="form-input" id="new-agent-email" name="email" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="new-agent-address">Address</label>
                <textarea class="form-input" id="new-agent-address" name="address" rows="3"></textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddAgentModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Agent</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Agent Modal -->
<div id="editAgentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Agent</h3>
            <button class="close-btn" onclick="closeEditAgentModal()">&times;</button>
        </div>
        <form id="editAgentForm">
            <input type="hidden" id="edit-agent-timestamp" name="timestamp">
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-agent-id">Agent ID *</label>
                    <input type="text" class="form-input" id="edit-agent-id" name="agentId" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-agent-name">Name *</label>
                    <input type="text" class="form-input" id="edit-agent-name" name="name" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-agent-phone">Phone *</label>
                    <input type="tel" class="form-input" id="edit-agent-phone" name="phone" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-agent-email">Email *</label>
                    <input type="email" class="form-input" id="edit-agent-email" name="email" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="edit-agent-address">Address</label>
                <textarea class="form-input" id="edit-agent-address" name="address" rows="3"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-agent-timestamp-display">Timestamp</label>
                    <input type="text" class="form-input" id="edit-agent-timestamp-display" disabled style="background-color: #f5f5f5;">
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEditAgentModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Agent</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Agent Confirmation Modal -->
<div id="deleteAgentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Delete Agent</h3>
            <button class="close-btn" onclick="closeDeleteAgentModal()">&times;</button>
        </div>
        <div class="form-group">
            <p id="delete-agent-confirm-text">Are you sure you want to delete this agent?</p>
            <input type="hidden" id="delete-agent-timestamp">
        </div>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteAgentModal()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteAgent()">Delete Agent</button>
        </div>
    </div>
</div>
<!-- Edit Order Modal -->
<div id="editOrderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Order</h3>
            <button class="close-btn" onclick="closeEditOrderModal()">&times;</button>
        </div>
        <form id="editOrderForm">
            <input type="hidden" id="edit-order-row" name="rowNumber">
            <input type="hidden" id="edit-order-original-billcode" name="originalBillCode">
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-order-timestamp">Timestamp</label>
                    <input type="text" class="form-input" id="edit-order-timestamp" name="timestamp" disabled style="background-color: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-order-name">Name *</label>
                    <input type="text" class="form-input" id="edit-order-name" name="name" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-order-phone">Phone *</label>
                    <input type="tel" class="form-input" id="edit-order-phone" name="phone" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-order-email">Email</label>
                    <input type="email" class="form-input" id="edit-order-email" name="email">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="edit-order-address">Address</label>
                <textarea class="form-input" id="edit-order-address" name="address" rows="3"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                     <label class="form-label" for="edit-order-product-code">Product Code</label>
                     <input type="text" class="form-input" id="edit-order-product-code" name="productCode">
                </div>
                <div class="form-group">
                     <label class="form-label" for="edit-order-product-name">Product Name</label>
                     <input type="text" class="form-input" id="edit-order-product-name" name="productName">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-order-product-quantity">Product Quantity</label>
                    <input type="number" class="form-input" id="edit-order-product-quantity" name="productQuantity" min="1" value="1">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-order-postage-fee">Postage Fee (RM)</label>
                    <input type="number" class="form-input" id="edit-order-postage-fee" name="postageFee" step="0.01" min="0" value="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-order-note">Note</label>
                    <textarea class="form-input" id="edit-order-note" name="note" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-order-spin-prize">Spin Prize</label>
                    <input type="text" class="form-input" id="edit-order-spin-prize" name="spinPrize">
                </div>
            </div>

<div class="form-row">
    <div class="form-group">
        <label class="form-label" for="edit-order-discount-code">Discount Code</label>
        <input type="text" class="form-input" id="edit-order-discount-code" name="discountCode">
    </div>
</div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-order-total">Total (RM)</label>
                    <input type="number" class="form-input" id="edit-order-total" name="total" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-order-payment-status">Payment Status</label>
                    <select class="form-input" id="edit-order-payment-status" name="paymentStatus" required>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-order-bill-code">Bill Code</label>
                    <input type="text" class="form-input" id="edit-order-bill-code" name="billCode" disabled style="background-color: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-order-delivery-status">Delivery Status *</label>
                    <select class="form-input" id="edit-order-delivery-status" name="deliveryStatus" required>
                        <option value="pending">Pending</option>
                        <option value="Notice">Notice</option>
                        <option value="Packing">Packing</option>
                        <option value="On Delivery">On Delivery</option>
                        <option value="Complete">Complete</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="edit-order-userid">User ID</label>
                    <input type="text" class="form-input" id="edit-order-userid" name="userid" disabled style="background-color: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-order-remark">Remark</label>
                    <textarea class="form-input" id="edit-order-remark" name="remark" rows="2"></textarea>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeEditOrderModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Order</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Order Confirmation Modal -->
<div id="deleteOrderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Delete Order</h3>
            <button class="close-btn" onclick="closeDeleteOrderModal()">&times;</button>
        </div>
        <div class="form-group">
            <p id="delete-order-confirm-text">Are you sure you want to delete this order?</p>
            <input type="hidden" id="delete-order-billcode">
        </div>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteOrderModal()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="confirmDeleteOrder()">Delete Order</button>
        </div>
    </div>
</div>
    </div>

    <script>
        // URLs for Google Apps Script Web Apps
        const ORDER_DATABASE_URL = 'https://script.google.com/macros/s/AKfycbxhuHO7-6fGOIS-BF9kUYHIBNzPVspo3MTyRIZvZnRY0WzuYOavP_gPoG_OJyuTShPq/exec';
        const AGENT_DATABASE_URL = 'https://script.google.com/macros/s/AKfycbwL86AaXKMwV7FBIQMcXCTt9qlCHDvi2Ftqzr-u5ePJGdgzMqqVWFQwdbXMRET8cldY/exec';
        const PRODUCT_DATABASE_URL = 'https://script.google.com/macros/s/AKfycbz1tnkvEKaOIi2k76YVws_OiItN8LJ_EMtv1VPkghOu71NJwlCDEBocIw2sneQE7xSRZQ/exec';
// Add this line with your other URL constants
        const SUPPLIER_DATABASE_URL = 'https://script.google.com/macros/s/AKfycbwYsRYtwcstQ1TbK0m8QyUBFmNydDQ2K-C8U1ANjZ4AZNySPsJI2el6QHFklWQ35Vb7/exec';

        // Global variables for data
        let ordersData = [];
        let agentsData = [];
        let productsData = [];
        let suppliersData = [];
        let ordersChart = null;
        let isInitialLoad = true; // Track if this is the initial load
        

// Commission rate configuration
const COMMISSION_RATES = {
    // Custom rates by product code
    customRates: {
        'B4': 10,
        'SV115': 30,
        'SV113': 30,
        'SV106': 30,
        'SV107': 30
    },
    // Common rates by inch size
    commonRates: {
        '4': 30,
        '5': 30,
        '6': 30,
        '7': 40,
        '8': 40,
        '9': 40,
        '10': 50,
        '11': 60,
        '12': 60,
        '18': 70,
        '22': 70,
        '24': 70
    }
};

        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Tab switching - FIXED VERSION
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        // Remove active class from all tabs and content
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(tabId).classList.add('active');
        
        // Always load data for the tab when clicked
        if (tabId === 'orders') {
            displayOrdersData();
        } else if (tabId === 'agents') {
            displayAgentsData();
        } else if (tabId === 'products') {
            displayProductsData(); 
        } else if (tabId === 'suppliers') {
            displaySuppliersData();
        }else if (tabId === 'sales-commission') {
            calculateAgentSales(); // Add this line
        } else if (tabId === 'dashboard') {
            updateDashboardStats();
        }
    });
});

       // Initialize the dashboard
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Load initial data for dashboard
        console.log('Loading data from Google Sheets...');
        
        // Fetch all data in parallel
        const [ordersResult, agentsResult, productsResult, suppliersResult] = await Promise.allSettled([
            fetchOrdersData(),
            fetchAgentsData(),
            fetchProductsData(),
            fetchSuppliersData() // Add this
        ]);
        
        // Handle orders data
        if (ordersResult.status === 'fulfilled') {
            ordersData = ordersResult.value;
            console.log('Orders data loaded:', ordersData.length, 'records');
        } else {
            console.error('Failed to load orders:', ordersResult.reason);
            showError(`Failed to load orders: ${ordersResult.reason.message || 'Unknown error'}`);
        }
        
        // Handle agents data
        if (agentsResult.status === 'fulfilled') {
            agentsData = agentsResult.value;
            console.log('Agents data loaded:', agentsData.length, 'records');
        } else {
            console.error('Failed to load agents:', agentsResult.reason);
            showError(`Failed to load agents: ${agentsResult.reason.message || 'Unknown error'}`);
        }
        
        // Handle products data
        if (productsResult.status === 'fulfilled') {
            productsData = productsResult.value;
            console.log('Products data loaded:', productsData.length, 'records');
        } else {
            console.error('Failed to load products:', productsResult.reason);
            showError(`Failed to load products: ${productsResult.reason.message || 'Unknown error'}`);
        }
        
        // Handle suppliers data
        if (suppliersResult.status === 'fulfilled') {
            suppliersData = suppliersResult.value;
            console.log('Suppliers data loaded:', suppliersData.length, 'records');
        } else {
            console.error('Failed to load suppliers:', suppliersResult.reason);
            showError(`Failed to load suppliers: ${suppliersResult.reason.message || 'Unknown error'}`);
        }
        
        updateDashboardStats();
        initializeOrdersChart();
        
        // Display orders data if orders tab is active
        if (document.getElementById('orders').classList.contains('active')) {
            displayOrdersData();
        }
        
        isInitialLoad = false;
        
    } catch (error) {
        console.error('Error loading data:', error);
        showError(`Failed to load data: ${error.message}`);
    }
    
    // Set up search and filter functionality
    setupEventListeners();
});

        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            errorText.textContent = message;
            errorElement.style.display = 'block';
            
            // Hide error after 10 seconds
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 10000);
        }

        // Function to fetch orders data
        async function fetchOrdersData() {
            try {
                console.log('Fetching orders data from:', ORDER_DATABASE_URL);
                const response = await fetch(ORDER_DATABASE_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Orders API response:', result);
                
                if (result.success && Array.isArray(result.data)) {
                    // The first row is headers, so skip it
                    const headers = result.data[0];
                    const rows = result.data.slice(1);
                    
                    // Convert rows to objects with header keys
                    return rows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index] || '';
                        });
                        return obj;
                    });
                } else {
                    throw new Error(result.message || 'Invalid data format from orders API');
                }
            } catch (error) {
                console.error('Error fetching orders data:', error);
                throw error;
            }
        }

// Function to fetch suppliers data
async function fetchSuppliersData() {
    try {
        console.log('Fetching suppliers data from:', SUPPLIER_DATABASE_URL);
        const response = await fetch(SUPPLIER_DATABASE_URL);
        
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Suppliers API response:', result);
        
        if (result.success && Array.isArray(result.data)) {
            return result.data;
        } else {
            throw new Error(result.message || 'Invalid data format from suppliers API');
        }
    } catch (error) {
        console.error('Error fetching suppliers data:', error);
        throw error;
    }
}

// Display suppliers data in table
function displaySuppliersData() {
    const tableBody = document.getElementById('suppliers-table-body');
    const loadingElement = document.getElementById('suppliers-loading');
    const tableElement = document.getElementById('suppliers-table');
    
    // Clear existing rows
    tableBody.innerHTML = '';
    
    // Show loading, hide table
    loadingElement.style.display = 'flex';
    tableElement.style.display = 'none';
    
    // Check if we have data
    if (!suppliersData || suppliersData.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="17" style="text-align: center; padding: 2rem;">
                    <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                    <p>No supplier data available.</p>
                </td>
            </tr>
        `;
        
        // Hide loading, show table
        loadingElement.style.display = 'none';
        tableElement.style.display = 'table';
        return;
    }
    
    // Populate table with suppliers data
    suppliersData.forEach(supplier => {
        const row = document.createElement('tr');
        
        // Escape special characters
        const code = escapeHtml(supplier.Code || 'N/A');
        const name = escapeHtml(supplier.Name || 'N/A');
        const shot = escapeHtml(supplier.Shot || 'N/A');
        const style = escapeHtml(supplier.Style || 'N/A');
        const inch = escapeHtml(supplier.Inch || 'N/A');
        const duration = escapeHtml(supplier.Duration || 'N/A');
        const postage = parseFloat(supplier.Postage || 0).toFixed(2);
        const rmSupplier = parseFloat(supplier['Rm (Supplier)'] || 0).toFixed(2);
        const rmAgent = parseFloat(supplier['Rm (Agent)'] || 0).toFixed(2);
        const rmMarket = parseFloat(supplier['Rm (Market)'] || 0).toFixed(2);
        const profitDirect = parseFloat(supplier['Profit (Direct Supplier)'] || 0).toFixed(2);
        const profitAgent = parseFloat(supplier['Profit (Agent)'] || 0).toFixed(2);
        const profitFromAgent = parseFloat(supplier['Profit (From Agent)'] || 0).toFixed(2);
        const image = escapeHtml(supplier.Image || '');
        const video = escapeHtml(supplier.Video || '');
        
        // Create preview for image and video
        const imagePreview = image ? 
            `<a href="${image}" target="_blank" title="${image}"><i class="fas fa-image"></i> View</a>` : 
            'N/A';
        const videoPreview = video ? 
            `<a href="${video}" target="_blank" title="${video}"><i class="fas fa-video"></i> View</a>` : 
            'N/A';
        
        row.innerHTML = `
            <td><strong>${code}</strong></td>
            <td>${name}</td>
            <td>${shot}</td>
            <td>${style}</td>
            <td>${inch}"</td>
            <td>${duration}</td>
            <td>RM ${postage}</td>
            <td>RM ${rmSupplier}</td>
            <td>RM ${rmAgent}</td>
            <td>RM ${rmMarket}</td>
            <td>RM ${profitDirect}</td>
            <td>RM ${profitAgent}</td>
            <td>RM ${profitFromAgent}</td>
            <td>${imagePreview}</td>
            <td>${videoPreview}</td>
            <td>
                <button class="action-btn edit" onclick="editSupplier('${code}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete" onclick="deleteSupplier('${code}')">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // Hide loading, show table
    loadingElement.style.display = 'none';
    tableElement.style.display = 'table';
}

// Supplier modal functions
function closeEditSupplierModal() {
    document.getElementById('editSupplierModal').style.display = 'none';
    document.getElementById('editSupplierForm').reset();
}

function closeDeleteSupplierModal() {
    document.getElementById('deleteSupplierModal').style.display = 'none';
}

function toggleAddSupplierForm() {
    const form = document.getElementById('addSupplierForm');
    const btn = document.getElementById('add-supplier-btn');
    
    if (form.classList.contains('active')) {
        form.classList.remove('active');
        btn.innerHTML = '<i class="fas fa-plus"></i> Add Supplier Product';
    } else {
        form.classList.add('active');
        btn.innerHTML = '<i class="fas fa-times"></i> Close Form';
        form.scrollIntoView({ behavior: 'smooth' });
    }
}

// Edit supplier
function editSupplier(supplierCode) {
    const supplier = suppliersData.find(s => s.Code === supplierCode);
    
    if (!supplier) {
        alert('Supplier product not found!');
        return;
    }
    
    // Fill the edit form with supplier data
    document.getElementById('edit-supplier-code').value = supplier.Code;
    document.getElementById('edit-supplier-code-display').value = supplier.Code;
    document.getElementById('edit-supplier-name').value = supplier.Name || '';
    document.getElementById('edit-supplier-shot').value = supplier.Shot || '';
    document.getElementById('edit-supplier-style').value = supplier.Style || 'S';
    document.getElementById('edit-supplier-inch').value = supplier.Inch || '';
    document.getElementById('edit-supplier-duration').value = supplier.Duration || '';
    document.getElementById('edit-supplier-postage').value = supplier.Postage || 0;
    document.getElementById('edit-supplier-rm_supplier').value = supplier['Rm (Supplier)'] || 0;
    document.getElementById('edit-supplier-rm_agent').value = supplier['Rm (Agent)'] || 0;
    document.getElementById('edit-supplier-rm_market').value = supplier['Rm (Market)'] || 0;
    document.getElementById('edit-supplier-profit_direct_supplier').value = supplier['Profit (Direct Supplier)'] || 0;
    document.getElementById('edit-supplier-profit_agent').value = supplier['Profit (Agent)'] || 0;
    document.getElementById('edit-supplier-profit_from_agent').value = supplier['Profit (From Agent)'] || 0;
    document.getElementById('edit-supplier-image').value = supplier.Image || '';
    document.getElementById('edit-supplier-video').value = supplier.Video || '';
    
    // Show the modal
    document.getElementById('editSupplierModal').style.display = 'block';
}

// Delete supplier
function deleteSupplier(supplierCode) {
    const supplier = suppliersData.find(s => s.Code === supplierCode);
    
    if (!supplier) {
        alert('Supplier product not found!');
        return;
    }
    
    document.getElementById('delete-supplier-code').value = supplierCode;
    document.getElementById('delete-supplier-confirm-text').textContent = 
        `Are you sure you want to delete supplier product "${supplier.Name}" (Code: ${supplierCode})?`;
    
    document.getElementById('deleteSupplierModal').style.display = 'block';
}

        // Function to fetch agents data - FIXED for email space issue
        async function fetchAgentsData() {
            try {
                console.log('Fetching agents data from:', AGENT_DATABASE_URL);
                const response = await fetch(AGENT_DATABASE_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Agents API response:', result);
                
                if (result.success && Array.isArray(result.data)) {
                    // The first row is headers, so skip it
                    const headers = result.data[0];
                    const rows = result.data.slice(1);
                    
                    // Convert rows to objects with header keys
                    return rows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            // Fix: Trim header names to remove trailing spaces
                            const cleanHeader = header.trim();
                            obj[cleanHeader] = row[index] || '';
                        });
                        return obj;
                    });
                } else {
                    throw new Error(result.message || 'Invalid data format from agents API');
                }
            } catch (error) {
                console.error('Error fetching agents data:', error);
                throw error;
            }
        }

        // Function to fetch products data
        async function fetchProductsData() {
            try {
                console.log('Fetching products data from:', PRODUCT_DATABASE_URL);
                const response = await fetch(PRODUCT_DATABASE_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Products API response:', result);
                
                // The product API has a different structure
                if (result.success && Array.isArray(result.data)) {
                    // If data is already an array of objects
                    if (result.data.length > 0 && typeof result.data[0] === 'object') {
                        return result.data;
                    }
                    // If data is array of arrays (with headers)
                    else if (Array.isArray(result.data[0])) {
                        const headers = result.data[0];
                        const rows = result.data.slice(1);
                        
                        // Convert rows to objects with header keys
                        return rows.map(row => {
                            const obj = {};
                            headers.forEach((header, index) => {
                                obj[header] = row[index] || '';
                            });
                            return obj;
                        });
                    }
                }
                
                throw new Error('Invalid data format from products API');
            } catch (error) {
                console.error('Error fetching products data:', error);
                throw error;
            }
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            // Total Orders
            document.getElementById('total-orders').textContent = ordersData.length;
            
            // Total Agents
            document.getElementById('total-agents').textContent = agentsData.length;
            
            // Total Products
            document.getElementById('total-products').textContent = productsData.length;
            
            // Total Revenue (sum of all orders with "Total" column)
            let totalRevenue = 0;
            ordersData.forEach(order => {
                const total = parseFloat(order.Total) || 0;
                totalRevenue += total;
            });
            document.getElementById('total-revenue').textContent = `RM ${totalRevenue.toFixed(2)}`;
        }

        // Initialize orders chart
        function initializeOrdersChart() {
            const ctx = document.getElementById('ordersChart').getContext('2d');
            
            // Sample data for the chart
            const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'];
            const data = [65, 59, 80, 81, 56, 55, 40];
            
            ordersChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Orders',
                        data: data,
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderColor: 'rgba(67, 97, 238, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    }
                }
            });
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        // Display orders data in table - FIXED with all columns
        function displayOrdersData() {
            const tableBody = document.getElementById('orders-table-body');
            const loadingElement = document.getElementById('orders-loading');
            const tableElement = document.getElementById('orders-table');
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // Show loading, hide table
            loadingElement.style.display = 'flex';
            tableElement.style.display = 'none';
            
            // Check if we have data
            if (!ordersData || ordersData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="17" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                            <p>No orders data available.</p>
                        </td>
                    </tr>
                `;
                
                // Hide loading, show table
                loadingElement.style.display = 'none';
                tableElement.style.display = 'table';
                return;
            }
            
            // Populate table with orders data
            ordersData.forEach(order => {
                const row = document.createElement('tr');
                
                // Determine payment status class
                const paymentStatus = order['Payment Status'] || 'pending';
                const paymentStatusClass = paymentStatus.toLowerCase() === 'paid' ? 'paid' : 'pending';
                
                // Determine delivery status class
                const deliveryStatus = order['Delivery Status'] || 'pending';
                const deliveryStatusClass = deliveryStatus.toLowerCase();
                let deliveryClass = 'pending';
                if (deliveryStatusClass === 'delivered' || deliveryStatusClass === 'complete') {
                    deliveryClass = 'delivered';
                } else if (deliveryStatusClass === 'cancelled') {
                    deliveryClass = 'cancelled';
                } else if (deliveryStatusClass === 'notice' || deliveryStatusClass === 'packing' || deliveryStatusClass === 'on delivery') {
                    deliveryClass = 'pending';
                }
                
                // Escape special characters to prevent XSS and template literal issues
                const timestamp = formatDate(order.Timestamp || 'N/A');
                const name = escapeHtml(order.Name || 'N/A');
                const phone = escapeHtml(order.Phone || 'N/A');
                const email = escapeHtml(order.Email || 'N/A');
                const contactInfo = `${phone}<br><small>${email}</small>`;
                const address = escapeHtml(order.Address || 'N/A');
                const productCode = escapeHtml(order['Product Code'] || 'N/A');
                const productName = escapeHtml(order['Product Name'] || 'N/A');
                const productInfo = `${productCode}<br><small>${productName}</small>`;
                const productQuantity = escapeHtml(order['Product Quantity'] || '1');
                const postageFee = parseFloat(order['Postage Fee'] || 0).toFixed(2);
                const note = escapeHtml(order.Note || 'N/A');
                const discountCode = escapeHtml(order['Discount Code'] || 'N/A');  // ADD THIS LINE
                const spinPrize = escapeHtml(order['Spin Prize'] || 'N/A');
                const total = parseFloat(order.Total || 0).toFixed(2);
                const billCode = escapeHtml(order['Bill Code'] || 'N/A');
                const userId = escapeHtml(order.UserId || 'N/A');
                const remark = escapeHtml(order.Remark || 'N/A');
                
                row.innerHTML = `
                    <td>${timestamp}</td>
                    <td>${name}</td>
                    <td>${contactInfo}</td>
                    <td><div class="compact-text" title="${address}">${address}</div></td>
                    <td>${productInfo}</td>
                    <td>${productQuantity}</td>
                    <td>RM ${postageFee}</td>
                    <td><div class="compact-text" title="${note}">${note}</div></td>
                    <td>${discountCode}</td>
                    <td>${spinPrize}</td>
                    <td>RM ${total}</td>
                    <td><span class="status ${paymentStatusClass}">${paymentStatus}</span></td>
                    <td>${billCode}</td>
                    <td><span class="status ${deliveryClass}">${deliveryStatus}</span></td>
                    <td>${userId}</td>
                    <td><div class="compact-text" title="${remark}">${remark}</div></td>
                    <td>
                        <button class="action-btn edit" onclick="editOrder('${billCode}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteOrder('${billCode}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Hide loading, show table
            loadingElement.style.display = 'none';
            tableElement.style.display = 'table';
        }

        // Display agents data in table - FIXED email issue
        function displayAgentsData() {
            const tableBody = document.getElementById('agents-table-body');
            const loadingElement = document.getElementById('agents-loading');
            const tableElement = document.getElementById('agents-table');
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // Show loading, hide table
            loadingElement.style.display = 'flex';
            tableElement.style.display = 'none';
            
            // Check if we have data
            if (!agentsData || agentsData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                            <p>No agents data available.</p>
                        </td>
                    </tr>
                `;
                
                // Hide loading, show table
                loadingElement.style.display = 'none';
                tableElement.style.display = 'table';
                return;
            }
            
            // Populate table with agents data
            agentsData.forEach(agent => {
                const row = document.createElement('tr');
                
                // Escape special characters
                // Try both "Email" and "Email " (with space) to handle the header issue
                const agentId = escapeHtml(agent['Agent ID'] || agent['Agent ID'] || 'N/A');
                const name = escapeHtml(agent.Name || agent.Name || 'N/A');
                const phone = escapeHtml(agent.Phone || agent.Phone || 'N/A');
                const email = escapeHtml(agent.Email || agent['Email '] || 'N/A'); // Try both with and without space
                const address = escapeHtml(agent.Address || agent.Address || 'N/A');
                
                row.innerHTML = `
                    <td>${agentId}</td>
                    <td>${name}</td>
                    <td>${phone}</td>
                    <td>${email}</td>
                    <td><div class="compact-text" title="${address}">${address}</div></td>
                    <td>${formatDate(agent.Timestamp || agent.Timestamp)}</td>
                    <td>
                        <button class="action-btn edit" onclick="editAgent('${agentId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteAgent('${agentId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Hide loading, show table
            loadingElement.style.display = 'none';
            tableElement.style.display = 'table';
        }        

                // Display products data in table - UPDATED with all columns
        function displayProductsData() {
            const tableBody = document.getElementById('products-table-body');
            const loadingElement = document.getElementById('products-loading');
            const tableElement = document.getElementById('products-table');
            
            // Clear existing rows
            tableBody.innerHTML = '';
            
            // Show loading, hide table
            loadingElement.style.display = 'flex';
            tableElement.style.display = 'none';
            
            // Check if we have data
            if (!productsData || productsData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 2rem;">
                            <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #6c757d; margin-bottom: 1rem;"></i>
                            <p>No products data available.</p>
                        </td>
                    </tr>
                `;
                
                // Hide loading, show table
                loadingElement.style.display = 'none';
                tableElement.style.display = 'table';
                return;
            }
            
            // Populate table with products data
            productsData.forEach(product => {
                const row = document.createElement('tr');
                
                // Escape special characters
                const code = escapeHtml(product.Code || 'N/A');
                const name = escapeHtml(product.Name || 'N/A');
                const shot = escapeHtml(product.Shot || 'N/A');
                const style = escapeHtml(product.Style || 'N/A');
                const inch = escapeHtml(product.Inch || 'N/A');
                const duration = escapeHtml(product.Duration || 'N/A');
                const postage = parseFloat(product.Postage || 0).toFixed(2);
                const price = parseFloat(product.Price || 0).toFixed(2);
                const image = escapeHtml(product.Image || '');
                const video = escapeHtml(product.Video || '');
                
                // Create preview for image and video
                const imagePreview = image ? 
                    `<a href="${image}" target="_blank" title="${image}"><i class="fas fa-image"></i> View</a>` : 
                    'N/A';
                const videoPreview = video ? 
                    `<a href="${video}" target="_blank" title="${video}"><i class="fas fa-video"></i> View</a>` : 
                    'N/A';
                
                row.innerHTML = `
                    <td><strong>${code}</strong></td>
                    <td>${name}</td>
                    <td>${shot}</td>
                    <td>${style}</td>
                    <td>${inch}"</td>
                    <td>${duration}</td>
                    <td>RM ${postage}</td>
                    <td>RM ${price}</td>
                    <td>${imagePreview}</td>
                    <td>${videoPreview}</td>
                    <td>
                        <button class="action-btn edit" onclick="editProduct('${code}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteProduct('${code}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Hide loading, show table
            loadingElement.style.display = 'none';
            tableElement.style.display = 'table';
        }       

        // Set up event listeners for search and filters
        function setupEventListeners() {
            // Order search
            const orderSearch = document.getElementById('order-search');
            orderSearch.addEventListener('input', function() {
                filterOrdersTable();
            });
            
            // Order status filter
            const orderStatusFilter = document.getElementById('order-status-filter');
            orderStatusFilter.addEventListener('change', function() {
                filterOrdersTable();
            });
            
            // Order delivery filter
            const orderDeliveryFilter = document.getElementById('order-delivery-filter');
            orderDeliveryFilter.addEventListener('change', function() {
                filterOrdersTable();
            });
            
            // Agent search
            const agentSearch = document.getElementById('agent-search');
            agentSearch.addEventListener('input', function() {
                filterAgentsTable();
            });
            
            // Product search
            const productSearch = document.getElementById('product-search');
            productSearch.addEventListener('input', function() {
                filterProductsTable();
            });

// Supplier search
const supplierSearch = document.getElementById('supplier-search');
supplierSearch.addEventListener('input', function() {
    filterSuppliersTable();
});

// Add supplier button
document.getElementById('add-supplier-btn').addEventListener('click', toggleAddSupplierForm);

// Cancel add supplier button
document.getElementById('cancel-add-supplier').addEventListener('click', function() {
    document.getElementById('addSupplierForm').classList.remove('active');
    document.getElementById('add-supplier-btn').innerHTML = '<i class="fas fa-plus"></i> Add Supplier Product';
    document.getElementById('addSupplierFormFields').reset();
});

// Handle add supplier form submission
document.getElementById('addSupplierFormFields').addEventListener('submit', handleAddSupplierSubmit);

// Handle edit supplier form submission
document.getElementById('editSupplierForm').addEventListener('submit', handleEditSupplierSubmit);
            
            // Add agent button
            document.getElementById('add-agent-btn').addEventListener('click', function() {
    document.getElementById('addAgentModal').style.display = 'block';
});
            
            // Chart period selector
            document.getElementById('chart-period').addEventListener('change', function() {
                alert('Chart would update based on selected period.');
                // In a real implementation, this would update the chart data
            });

 // Sales search
    const salesSearch = document.getElementById('sales-search');
    salesSearch.addEventListener('input', function() {
        filterSalesTable();
    });
    
    // Refresh sales button
    document.getElementById('refresh-sales-btn').addEventListener('click', function() {
        calculateAgentSales();
    });
    
    // Export sales button
document.getElementById('export-sales-btn').addEventListener('click', async function() {
    const agentSales = await calculateAgentSales();
    exportSalesToCSV(agentSales);
});
        }

// Filter sales table based on search
function filterSalesTable() {
    const searchTerm = document.getElementById('sales-search').value.toLowerCase();
    const rows = document.querySelectorAll('#sales-table-body tr');
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length === 0) return; // Skip empty rows
        
        const userId = cells[0].textContent.toLowerCase();
        
        const matchesSearch = !searchTerm || 
            userId.includes(searchTerm);
        
        if (matchesSearch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Filter suppliers table
function filterSuppliersTable() {
    const searchTerm = document.getElementById('supplier-search').value.toLowerCase();
    const rows = document.querySelectorAll('#suppliers-table-body tr');
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length === 0) return;
        
        const code = cells[0].textContent.toLowerCase();
        const name = cells[1].textContent.toLowerCase();
        const style = cells[3].textContent.toLowerCase();
        
        const matchesSearch = !searchTerm || 
            code.includes(searchTerm) || 
            name.includes(searchTerm) || 
            style.includes(searchTerm);
        
        if (matchesSearch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Handle add supplier form submission
async function handleAddSupplierSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const supplierData = {
        action: 'add',
        supplier_code: formData.get('supplier_code'),
        supplier_name: formData.get('supplier_name'),
        supplier_shot: formData.get('supplier_shot'),
        supplier_style: formData.get('supplier_style'),
        supplier_inch: formData.get('supplier_inch'),
        supplier_duration: formData.get('supplier_duration'),
        supplier_postage: formData.get('supplier_postage'),
        supplier_rm_supplier: formData.get('supplier_rm_supplier'),
        supplier_rm_agent: formData.get('supplier_rm_agent'),
        supplier_rm_market: formData.get('supplier_rm_market'),
        supplier_profit_direct_supplier: formData.get('supplier_profit_direct_supplier'),
        supplier_profit_agent: formData.get('supplier_profit_agent'),
        supplier_profit_from_agent: formData.get('supplier_profit_from_agent'),
        supplier_image: formData.get('supplier_image'),
        supplier_video: formData.get('supplier_video')
    };
    
    // Validate required fields
    if (!supplierData.supplier_code || !supplierData.supplier_name) {
        alert('Please fill in all required fields (Code, Name)');
        return;
    }
    
    try {
        const response = await fetch(SUPPLIER_DATABASE_URL, {
            method: 'POST',
            body: JSON.stringify(supplierData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Supplier product added successfully!');
            
            e.target.reset();
            document.getElementById('addSupplierForm').classList.remove('active');
            document.getElementById('add-supplier-btn').innerHTML = '<i class="fas fa-plus"></i> Add Supplier Product';
            
            // Refresh suppliers data
            suppliersData = await fetchSuppliersData();
            displaySuppliersData();
        } else {
            alert('Error adding supplier product: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        alert('Error adding supplier product: ' + error.message);
    }
}

// Handle edit supplier form submission
async function handleEditSupplierSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const supplierData = {
        action: 'update',
        supplier_code: formData.get('supplier_code'),
        supplier_name: formData.get('supplier_name'),
        supplier_shot: formData.get('supplier_shot'),
        supplier_style: formData.get('supplier_style'),
        supplier_inch: formData.get('supplier_inch'),
        supplier_duration: formData.get('supplier_duration'),
        supplier_postage: formData.get('supplier_postage'),
        supplier_rm_supplier: formData.get('supplier_rm_supplier'),
        supplier_rm_agent: formData.get('supplier_rm_agent'),
        supplier_rm_market: formData.get('supplier_rm_market'),
        supplier_profit_direct_supplier: formData.get('supplier_profit_direct_supplier'),
        supplier_profit_agent: formData.get('supplier_profit_agent'),
        supplier_profit_from_agent: formData.get('supplier_profit_from_agent'),
        supplier_image: formData.get('supplier_image'),
        supplier_video: formData.get('supplier_video')
    };
    
    try {
        const response = await fetch(SUPPLIER_DATABASE_URL, {
            method: 'POST',
            body: JSON.stringify(supplierData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Supplier product updated successfully!');
            closeEditSupplierModal();
            
            // Refresh the suppliers data
            suppliersData = await fetchSuppliersData();
            displaySuppliersData();
        } else {
            alert('Error updating supplier product: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        alert('Error updating supplier product: ' + error.message);
    }
}

// Confirm delete supplier
async function confirmDeleteSupplier() {
    const supplierCode = document.getElementById('delete-supplier-code').value;
    
    try {
        const response = await fetch(SUPPLIER_DATABASE_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'delete',
                supplier_code: supplierCode
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Supplier product deleted successfully!');
            closeDeleteSupplierModal();
            
            // Refresh the suppliers data
            suppliersData = await fetchSuppliersData();
            displaySuppliersData();
        } else {
            alert('Error deleting supplier product: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        alert('Error deleting supplier product: ' + error.message);
    }
}

// Add event listeners for URL preview updates in supplier add form
document.getElementById('add-supplier-image').addEventListener('input', function() {
    updateSupplierAddUrlPreview('image', this.value);
});

document.getElementById('add-supplier-video').addEventListener('input', function() {
    updateSupplierAddUrlPreview('video', this.value);
});

// Add event listeners for URL preview updates in supplier edit form
document.getElementById('edit-supplier-image').addEventListener('input', function() {
    updateSupplierEditUrlPreview('image', this.value);
});

document.getElementById('edit-supplier-video').addEventListener('input', function() {
    updateSupplierEditUrlPreview('video', this.value);
});

// URL preview functions for supplier forms
function updateSupplierAddUrlPreview(type, url) {
    const previewElement = document.getElementById(`add-supplier-${type}-preview`);
    if (url) {
        previewElement.innerHTML = `<a href="${url}" target="_blank" title="${url}">${url.substring(0, 50)}${url.length > 50 ? '...' : ''}</a>`;
    } else {
        previewElement.innerHTML = '';
    }
}

function updateSupplierEditUrlPreview(type, url) {
    const previewElement = document.getElementById(`edit-supplier-${type}-preview`);
    if (url) {
        previewElement.innerHTML = `<a href="${url}" target="_blank" title="${url}">${url.substring(0, 50)}${url.length > 50 ? '...' : ''}</a>`;
    } else {
        previewElement.innerHTML = '';
    }
}

        // Filter orders table based on search and filters
        function filterOrdersTable() {
            const searchTerm = document.getElementById('order-search').value.toLowerCase();
            const statusFilter = document.getElementById('order-status-filter').value;
            const deliveryFilter = document.getElementById('order-delivery-filter').value;
            
            const rows = document.querySelectorAll('#orders-table-body tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return; // Skip empty rows
                
                const name = cells[1].textContent.toLowerCase();
                const contact = cells[2].textContent.toLowerCase();
                const address = cells[3].textContent.toLowerCase();
                const product = cells[4].textContent.toLowerCase();
                const billCode = cells[11].textContent.toLowerCase();
                const paymentStatus = cells[10].querySelector('.status') ? cells[10].querySelector('.status').textContent.toLowerCase() : '';
                const deliveryStatus = cells[12].querySelector('.status') ? cells[12].querySelector('.status').textContent.toLowerCase() : '';
                
                const matchesSearch = !searchTerm || 
                    name.includes(searchTerm) || 
                    contact.includes(searchTerm) || 
                    address.includes(searchTerm) ||
                    product.includes(searchTerm) ||
                    billCode.includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || paymentStatus === statusFilter;
                const matchesDelivery = deliveryFilter === 'all' || deliveryStatus === deliveryFilter;
                
                if (matchesSearch && matchesStatus && matchesDelivery) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Filter agents table based on search
        function filterAgentsTable() {
            const searchTerm = document.getElementById('agent-search').value.toLowerCase();
            const rows = document.querySelectorAll('#agents-table-body tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return; // Skip empty rows
                
                const name = cells[1].textContent.toLowerCase();
                const phone = cells[2].textContent.toLowerCase();
                const email = cells[3].textContent.toLowerCase();
                const agentId = cells[0].textContent.toLowerCase();
                
                const matchesSearch = !searchTerm || 
                    name.includes(searchTerm) || 
                    phone.includes(searchTerm) || 
                    email.includes(searchTerm) ||
                    agentId.includes(searchTerm);
                
                if (matchesSearch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }


                // Filter products table based on search
        function filterProductsTable() {
            const searchTerm = document.getElementById('product-search').value.toLowerCase();
            const rows = document.querySelectorAll('#products-table-body tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return; // Skip empty rows
                
                const code = cells[0].textContent.toLowerCase();
                const name = cells[1].textContent.toLowerCase();
                const style = cells[3].textContent.toLowerCase();
                const shot = cells[2].textContent.toLowerCase();
                
                const matchesSearch = !searchTerm || 
                    code.includes(searchTerm) || 
                    name.includes(searchTerm) || 
                    style.includes(searchTerm) ||
                    shot.includes(searchTerm);
                
                if (matchesSearch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

async function editOrder(billCode) {
    try {
        const response = await fetch(`${ORDER_DATABASE_URL}?orderId=${encodeURIComponent(billCode)}`);
        const result = await response.json();

        console.log('Edit Order Response:', result);
        
        if (!result.success || !result.order) {
            alert('Order not found: ' + (result.message || 'Unknown error'));
            return;
        }
        
        const order = result.order;

        // Fill the edit form with order data
        document.getElementById('edit-order-row').value = order.rowNumber || '';
        document.getElementById('edit-order-original-billcode').value = order.billCode || '';
        
        document.getElementById('edit-order-timestamp').value = formatDate(order.timestamp) || '';
        const name = order.customerName || order.CustomerName || order.name || order.Name || '';
        document.getElementById('edit-order-name').value = name;
        document.getElementById('edit-order-phone').value = order.customerPhone || '';
        document.getElementById('edit-order-email').value = order.customerEmail || '';
        document.getElementById('edit-order-address').value = order.deliveryAddress || '';
        const productCode = order.productCode || order.ProductCode || '';
        document.getElementById('edit-order-product-code').value = productCode;
        document.getElementById('edit-order-product-name').value = order.productName || '';
        document.getElementById('edit-order-product-quantity').value = order.productQuantity || 1;
        document.getElementById('edit-order-postage-fee').value = order.postageFee || 0;
        document.getElementById('edit-order-note').value = order.customerNote || '';
        document.getElementById('edit-order-discount-code').value = order.discountCode || '';
        document.getElementById('edit-order-spin-prize').value = order.spinPrize || '';
        document.getElementById('edit-order-total').value = order.totalPrice || 0;
        document.getElementById('edit-order-payment-status').value = order.paymentStatus || 'pending';
        document.getElementById('edit-order-bill-code').value = order.billCode || '';
        document.getElementById('edit-order-delivery-status').value = order.deliveryStatus || 'pending';
        document.getElementById('edit-order-userid').value = order.userId || '';
        document.getElementById('edit-order-remark').value = order.remark || '';
        
        // Show the modal
        document.getElementById('editOrderModal').style.display = 'block';
        
    } catch (error) {
        console.error('Error loading order for editing:', error);
        alert('Error loading order: ' + error.message);
    }
}

       // Delete Order - Opens confirmation modal
function deleteOrder(billCode) {
    // Set the bill code in the delete modal
    document.getElementById('delete-order-billcode').value = billCode;
    document.getElementById('delete-order-confirm-text').textContent = 
        `Are you sure you want to delete order with Bill Code: ${billCode}?`;
    
    // Show the delete modal
    document.getElementById('deleteOrderModal').style.display = 'block';
}

// Close edit order modal
function closeEditOrderModal() {
    document.getElementById('editOrderModal').style.display = 'none';
    document.getElementById('editOrderForm').reset();
}

// Close delete order modal
function closeDeleteOrderModal() {
    document.getElementById('deleteOrderModal').style.display = 'none';
}

document.getElementById('editOrderForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const orderData = {
        action: 'updateOrder',
        originalBillCode: formData.get('originalBillCode'),
        rowNumber: formData.get('rowNumber'),
        name: document.getElementById('edit-order-name').value,
        phone: document.getElementById('edit-order-phone').value,
        email: document.getElementById('edit-order-email').value,
        address: document.getElementById('edit-order-address').value,
        productCode: document.getElementById('edit-order-product-code').value,
        productName: document.getElementById('edit-order-product-name').value,
        productQuantity: document.getElementById('edit-order-product-quantity').value,
        postageFee: document.getElementById('edit-order-postage-fee').value,
        note: document.getElementById('edit-order-note').value,
        discountCode: document.getElementById('edit-order-discount-code').value,
        spinPrize: document.getElementById('edit-order-spin-prize').value,
        total: document.getElementById('edit-order-total').value,
        paymentStatus: document.getElementById('edit-order-payment-status').value,
        deliveryStatus: document.getElementById('edit-order-delivery-status').value,
        remark: document.getElementById('edit-order-remark').value
    };
    
    // Validate required fields
    if (!orderData.name || !orderData.phone || !orderData.total) {
        alert('Please fill in all required fields (Name, Phone, Total)');
        return;
    }
    
    try {
        const response = await fetch(ORDER_DATABASE_URL, {
            method: 'POST',
            body: JSON.stringify(orderData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Order updated successfully!');
            closeEditOrderModal();
            
            // Refresh the orders data
            ordersData = await fetchOrdersData();
            displayOrdersData();
            updateDashboardStats();
        } else {
            alert('Error updating order: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        alert('Error updating order: ' + error.message);
    }
});

// Confirm delete order
async function confirmDeleteOrder() {
    const billCode = document.getElementById('delete-order-billcode').value;
    
    if (!billCode) {
        alert('Cannot delete order: Missing Bill Code');
        return;
    }
    
    try {
        const response = await fetch(ORDER_DATABASE_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'deleteOrder',
                billCode: billCode
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Order deleted successfully!');
            closeDeleteOrderModal();
            
            // Refresh the orders data
            ordersData = await fetchOrdersData();
            displayOrdersData();
            updateDashboardStats();
        } else {
            alert('Error deleting order: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        alert('Error deleting order: ' + error.message);
    }
}

        // Edit agent - Opens modal
function editAgent(agentId) {
    // Find the agent in our data using Agent ID
    const agent = agentsData.find(a => a['Agent ID'] === agentId || a['Agent ID '] === agentId);
    
    if (!agent) {
        alert('Agent not found!');
        return;
    }
    
    // Fill the edit form with agent data
    document.getElementById('edit-agent-timestamp').value = agent.Timestamp || '';
    document.getElementById('edit-agent-id').value = agentId;
    document.getElementById('edit-agent-name').value = agent.Name || '';
    document.getElementById('edit-agent-phone').value = agent.Phone || '';
    document.getElementById('edit-agent-email').value = agent.Email || agent['Email '] || '';
    document.getElementById('edit-agent-address').value = agent.Address || '';
    
    // Display timestamp (disabled field)
    document.getElementById('edit-agent-timestamp-display').value = formatDate(agent.Timestamp || '');
    
    // Show the modal
    document.getElementById('editAgentModal').style.display = 'block';
}

// Delete agent - Opens confirmation modal
function deleteAgent(agentId) {
    // Find the agent in our data using Agent ID
    const agent = agentsData.find(a => a['Agent ID'] === agentId || a['Agent ID '] === agentId);
    
    if (!agent) {
        alert('Agent not found!');
        return;
    }
    
    // Set the agent timestamp in the delete modal
    document.getElementById('delete-agent-timestamp').value = agent.Timestamp || '';
    document.getElementById('delete-agent-confirm-text').textContent = 
        `Are you sure you want to delete agent "${agent.Name}" (ID: ${agentId})?`;
    
    // Show the delete modal
    document.getElementById('deleteAgentModal').style.display = 'block';
}

           // Edit product - UPDATED with modal
        function editProduct(productCode) {
            // Find the product in our data
            const product = productsData.find(p => p.Code === productCode);
            
            if (!product) {
                alert('Product not found!');
                return;
            }
            
            // Fill the edit form with product data
            document.getElementById('edit-product-code').value = product.Code;
            document.getElementById('edit-code').value = product.Code;
            document.getElementById('edit-name').value = product.Name || '';
            document.getElementById('edit-shot').value = product.Shot || '';
            document.getElementById('edit-style').value = product.Style || 'S';
            document.getElementById('edit-inch').value = product.Inch || '';
            document.getElementById('edit-duration').value = product.Duration || '';
            document.getElementById('edit-postage').value = product.Postage || 0;
            document.getElementById('edit-price').value = product.Price || 0;
            document.getElementById('edit-image').value = product.Image || '';
            document.getElementById('edit-video').value = product.Video || '';
            
            // Update previews
            updateUrlPreview('image', product.Image);
            updateUrlPreview('video', product.Video);
            
            // Show the modal
            document.getElementById('editProductModal').style.display = 'block';
        }

         // Delete product - UPDATED with modal
        function deleteProduct(productCode) {
            // Find the product in our data
            const product = productsData.find(p => p.Code === productCode);
            
            if (!product) {
                alert('Product not found!');
                return;
            }
            
            // Set the product code in the delete modal
            document.getElementById('delete-product-code').value = productCode;
            document.getElementById('delete-confirm-text').textContent = 
                `Are you sure you want to delete product "${product.Name}" (Code: ${productCode})?`;
            
            // Show the delete modal
            document.getElementById('deleteProductModal').style.display = 'block';
        }
 // Close edit modal
        function closeEditModal() {
            document.getElementById('editProductModal').style.display = 'none';
            document.getElementById('editProductForm').reset();
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteProductModal').style.display = 'none';
        }

     // Update URL preview
        function updateUrlPreview(type, url) {
            const previewElement = document.getElementById(`${type}-preview`);
            if (url) {
                previewElement.innerHTML = `<a href="${url}" target="_blank" title="${url}">${url.substring(0, 50)}${url.length > 50 ? '...' : ''}</a>`;
            } else {
                previewElement.innerHTML = '';
            }
        }

        // Handle edit form submission
        document.getElementById('editProductForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                action: 'update',
                code: document.getElementById('edit-product-code').value,
                name: document.getElementById('edit-name').value,
                shot: document.getElementById('edit-shot').value,
                style: document.getElementById('edit-style').value,
                inch: document.getElementById('edit-inch').value,
                duration: document.getElementById('edit-duration').value,
                postage: document.getElementById('edit-postage').value,
                price: document.getElementById('edit-price').value,
                image: document.getElementById('edit-image').value,
                video: document.getElementById('edit-video').value
            };
            
            try {
                const response = await fetch(PRODUCT_DATABASE_URL, {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Product updated successfully!');
                    closeEditModal();
                    
                    // Refresh the products data
                    productsData = await fetchProductsData();
                    displayProductsData();
                    updateDashboardStats();
                } else {
                    alert('Error updating product: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Error updating product: ' + error.message);
            }
        });

 // Confirm delete product
        async function confirmDeleteProduct() {
            const productCode = document.getElementById('delete-product-code').value;
            
            try {
                const response = await fetch(PRODUCT_DATABASE_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'delete',
                        code: productCode
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Product deleted successfully!');
                    closeDeleteModal();
                    
                    // Refresh the products data
                    productsData = await fetchProductsData();
                    displayProductsData();
                    updateDashboardStats();
                } else {
                    alert('Error deleting product: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Error deleting product: ' + error.message);
            }
        }

        // Add event listeners for URL preview updates
        document.getElementById('edit-image').addEventListener('input', function() {
            updateUrlPreview('image', this.value);
        });

        document.getElementById('edit-video').addEventListener('input', function() {
            updateUrlPreview('video', this.value);
        });

        // Add product button functionality
document.getElementById('add-product-btn').addEventListener('click', toggleAddProductForm);

// Cancel add product button
document.getElementById('cancel-add-product').addEventListener('click', function() {
    document.getElementById('addProductForm').classList.remove('active');
    document.getElementById('add-product-btn').innerHTML = '<i class="fas fa-plus"></i> Add Product';
    document.getElementById('addProductFormFields').reset();
});

// Handle add product form submission
document.getElementById('addProductFormFields').addEventListener('submit', handleAddProductSubmit);

// Add event listeners for URL preview updates in add form
document.getElementById('add-image').addEventListener('input', function() {
    updateAddUrlPreview('image', this.value);
});

document.getElementById('add-video').addEventListener('input', function() {
    updateAddUrlPreview('video', this.value);
});
        
// Toggle add product form
function toggleAddProductForm() {
    const form = document.getElementById('addProductForm');
    const btn = document.getElementById('add-product-btn');
    
    if (form.classList.contains('active')) {
        form.classList.remove('active');
        btn.innerHTML = '<i class="fas fa-plus"></i> Add Product';
    } else {
        form.classList.add('active');
        btn.innerHTML = '<i class="fas fa-times"></i> Close Form';
        // Scroll to form
        form.scrollIntoView({ behavior: 'smooth' });
    }
}

// Handle add product form submission
async function handleAddProductSubmit(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const productData = {
        action: 'add',
        code: formData.get('code'),
        name: formData.get('name'),
        shot: formData.get('shot'),
        style: formData.get('style'),
        inch: formData.get('inch'),
        duration: formData.get('duration'),
        postage: formData.get('postage'),
        price: formData.get('price'),
        image: formData.get('image'),
        video: formData.get('video')
    };
    
    // Validate required fields
    if (!productData.code || !productData.name || !productData.price) {
        alert('Please fill in all required fields (Code, Name, Price)');
        return;
    }
    
    try {
        const response = await fetch(PRODUCT_DATABASE_URL, {
            method: 'POST',
            body: JSON.stringify(productData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Product added successfully!');
            
            // Reset form
            e.target.reset();
            document.getElementById('addProductForm').classList.remove('active');
            document.getElementById('add-product-btn').innerHTML = '<i class="fas fa-plus"></i> Add Product';
            
            // Refresh products data
            productsData = await fetchProductsData();
            displayProductsData();
            updateDashboardStats();
        } else {
            alert('Error adding product: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        alert('Error adding product: ' + error.message);
    }
}

function updateAddUrlPreview(type, url) {
    const previewElement = document.getElementById(`add-${type}-preview`);
    if (url) {
        previewElement.innerHTML = `<a href="${url}" target="_blank" title="${url}">${url.substring(0, 50)}${url.length > 50 ? '...' : ''}</a>`;
    } else {
        previewElement.innerHTML = '';
    }
}

// Add these modal control functions:
function closeAddAgentModal() {
    document.getElementById('addAgentModal').style.display = 'none';
    document.getElementById('addAgentForm').reset();
}

function closeEditAgentModal() {
    document.getElementById('editAgentModal').style.display = 'none';
    document.getElementById('editAgentForm').reset();
}

function closeDeleteAgentModal() {
    document.getElementById('deleteAgentModal').style.display = 'none';
}

// Handle add agent form submission
document.getElementById('addAgentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const agentData = {
        action: 'add',
        agentId: formData.get('agentId'),
        name: formData.get('name'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        address: formData.get('address')
    };
    
    // Validate required fields
    if (!agentData.agentId || !agentData.name || !agentData.phone || !agentData.email) {
        alert('Please fill in all required fields');
        return;
    }
    
    try {
        const response = await fetch(AGENT_DATABASE_URL, {
            method: 'POST',
            body: JSON.stringify(agentData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Agent added successfully!');
            closeAddAgentModal();
            
            // Refresh the agents data
            agentsData = await fetchAgentsData();
            displayAgentsData();
            updateDashboardStats();
        } else {
            alert('Error adding agent: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        alert('Error adding agent: ' + error.message);
    }
});

// Handle edit agent form submission
document.getElementById('editAgentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const agentData = {
        action: 'update',
        timestamp: formData.get('timestamp'),
        agentId: formData.get('agentId'),
        name: formData.get('name'),
        phone: formData.get('phone'),
        email: formData.get('email'),
        address: formData.get('address')
    };
    
    // Validate required fields
    if (!agentData.timestamp || !agentData.agentId || !agentData.name || !agentData.phone || !agentData.email) {
        alert('Please fill in all required fields');
        return;
    }
    
    try {
        const response = await fetch(AGENT_DATABASE_URL, {
            method: 'POST',
            body: JSON.stringify(agentData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Agent updated successfully!');
            closeEditAgentModal();
            
            // Refresh the agents data
            agentsData = await fetchAgentsData();
            displayAgentsData();
            updateDashboardStats();
        } else {
            alert('Error updating agent: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        alert('Error updating agent: ' + error.message);
    }
});

// Confirm delete agent
async function confirmDeleteAgent() {
    const timestamp = document.getElementById('delete-agent-timestamp').value;
    
    if (!timestamp) {
        alert('Cannot delete agent: Missing timestamp');
        return;
    }
    
    try {
        const response = await fetch(AGENT_DATABASE_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'delete',
                timestamp: timestamp
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Agent deleted successfully!');
            closeDeleteAgentModal();
            
            // Refresh the agents data
            agentsData = await fetchAgentsData();
            displayAgentsData();
            updateDashboardStats();
        } else {
            alert('Error deleting agent: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        alert('Error deleting agent: ' + error.message);
    }
}

// Helper function to get commission rate for a product
function getCommissionRate(productCode, inch) {
    // Check custom rates first
    if (COMMISSION_RATES.customRates[productCode]) {
        return COMMISSION_RATES.customRates[productCode];
    }
    
    // Check common rates by inch (convert inch to string without decimal for matching)
    if (inch) {
        const inchStr = parseFloat(inch).toString();
        if (COMMISSION_RATES.commonRates[inchStr]) {
            return COMMISSION_RATES.commonRates[inchStr];
        }
    }
    
    // Default rate if no match
    return 0;
}

// Function to get supplier cost for a product
function getSupplierCost(productCode, suppliersData) {
    if (!suppliersData) return 0;
    
    // Find supplier by product code
    const supplier = suppliersData.find(s => s.Code === productCode);
    
    // Return Rm (Supplier) or 0 if not found
    if (supplier && supplier['Rm (Supplier)']) {
        return parseFloat(supplier['Rm (Supplier)']) || 0;
    }
    
    return 0;
}

// Function to get inch size for a product from suppliers data
function getProductInch(productCode, suppliersData) {
    if (!suppliersData) return null;
    
    const supplier = suppliersData.find(s => s.Code === productCode);
    return supplier ? supplier.Inch : null;
}

// Function to fetch product details by code
async function getProductByCode(productCode) {
    try {
        const response = await fetch(`${PRODUCT_DATABASE_URL}?search=${encodeURIComponent(productCode)}&format=json`);
        const result = await response.json();
        
        if (result.success && result.data && result.data.length > 0) {
            return result.data.find(product => product.Code === productCode) || result.data[0];
        }
        return null;
    } catch (error) {
        console.error('Error fetching product:', error);
        return null;
    }
}

// Function to calculate agent sales and commissions
async function calculateAgentSales() {
    try {
        const salesLoading = document.getElementById('sales-loading');
        const salesTable = document.getElementById('sales-table');
        const salesTableBody = document.getElementById('sales-table-body');
        
        // Show loading, hide table
        salesLoading.style.display = 'flex';
        salesTable.style.display = 'none';
        salesTableBody.innerHTML = '';
        
        // Make sure suppliers data is loaded
        if (!suppliersData || suppliersData.length === 0) {
            suppliersData = await fetchSuppliersData();
        }
        
        // Group orders by UserId
        const agentSales = {};
        
        // Process each order
        for (const order of ordersData) {
            const userId = order.UserId || 'N/A';
            
            if (!agentSales[userId]) {
                agentSales[userId] = {
                    userId: userId,
                    totalOrders: 0,
                    totalQty: 0,
                    totalPostage: 0,
                    totalDiscount: 0,
                    totalSpinPrize: 0,
                    totalPrice: 0,
                    totalCommission: 0,
                    totalSupplier: 0,
                    totalProfit: 0
                };
            }
            
            const agent = agentSales[userId];
            
            // Count each order (RM1 toyyibpay payment gateway fee per order)
            agent.totalOrders += 1;
            
            // Add product quantity
            const qty = parseInt(order['Product Quantity']) || 1;
            agent.totalQty += qty;
            
            // Add postage fee
            const postage = parseFloat(order['Postage Fee']) || 0;
            agent.totalPostage += postage;
            
            // Add discount code (assuming it's an amount in RM)
            const discount = parseFloat(order['Discount Code']) || 0;
            agent.totalDiscount += discount;
            
            // Add spin prize (assuming it's an amount in RM)
            const spinPrize = parseFloat(order['Spin Prize']) || 0;
            agent.totalSpinPrize += spinPrize;
            
            // Add total price
            const price = parseFloat(order.Total) || 0;
            agent.totalPrice += price;
            
            // Get product code
            const productCode = order['Product Code'] || '';
            
            // Get inch size from suppliers data for commission calculation
            const inch = getProductInch(productCode, suppliersData);
            
            // Calculate commission
            const commissionRate = getCommissionRate(productCode, inch);
            const commission = commissionRate * qty;
            agent.totalCommission += commission;
            
            // Calculate supplier cost
            const supplierCost = getSupplierCost(productCode, suppliersData);
            agent.totalSupplier += (supplierCost * qty);
        }
        
        // Calculate profit for each agent
        Object.values(agentSales).forEach(agent => {
            // Total Profit = Total Price - Total Orders (RM1 per order) - Total Commission - Total Postage - Total Supplier
            agent.totalProfit = agent.totalPrice - agent.totalOrders - agent.totalCommission - agent.totalPostage - agent.totalSupplier;
        });
        
        // Display the data
        displayAgentSales(agentSales);
        
        // Return the data for export
        return agentSales;
        
    } catch (error) {
        console.error('Error calculating agent sales:', error);
        showError(`Failed to calculate sales: ${error.message}`);
        
        // Hide loading, show empty table
        document.getElementById('sales-loading').style.display = 'none';
        document.getElementById('sales-table').style.display = 'table';
        
        return {};
    }
}

// Function to display agent sales data
function displayAgentSales(agentSales) {
    const salesTableBody = document.getElementById('sales-table-body');
    const salesLoading = document.getElementById('sales-loading');
    const salesTable = document.getElementById('sales-table');
    
    // Clear existing rows
    salesTableBody.innerHTML = '';
    
    // Convert object to array and sort by UserId
    const agentsArray = Object.values(agentSales);
    agentsArray.sort((a, b) => a.userId.localeCompare(b.userId));
    
    // Populate table
    agentsArray.forEach(agent => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td><strong>${escapeHtml(agent.userId)}</strong></td>
            <td>${agent.totalOrders}</td>
            <td>${agent.totalQty}</td>
            <td>RM ${agent.totalPostage.toFixed(2)}</td>
            <td>RM ${agent.totalDiscount.toFixed(2)}</td>
            <td>RM ${agent.totalSpinPrize.toFixed(2)}</td>
            <td>RM ${agent.totalPrice.toFixed(2)}</td>
            <td>RM ${agent.totalCommission.toFixed(2)}</td>
            <td>RM ${agent.totalSupplier.toFixed(2)}</td>
            <td><strong>RM ${agent.totalProfit.toFixed(2)}</strong></td>
        `;
        
        // Highlight profit column
        const profitCell = row.cells[9];
        if (agent.totalProfit > 0) {
            profitCell.style.color = '#28a745';
            profitCell.style.fontWeight = 'bold';
        } else if (agent.totalProfit < 0) {
            profitCell.style.color = '#dc3545';
            profitCell.style.fontWeight = 'bold';
        }
        
        salesTableBody.appendChild(row);
    });
    
    // Hide loading, show table
    salesLoading.style.display = 'none';
    salesTable.style.display = 'table';
}

// Function to export sales data to CSV
function exportSalesToCSV(agentSales) {
    const agentsArray = Object.values(agentSales);
    agentsArray.sort((a, b) => a.userId.localeCompare(b.userId));
    
    // CSV header
    let csv = 'User ID,Total Orders,Total Qty Product,Total Postage (RM),Total Discount Code (RM),Total Spin Prize (RM),Total Price (RM),Total Commission (RM),Total Supplier (RM),Total Profit (RM)\n';
    
    // CSV data
    agentsArray.forEach(agent => {
        csv += `"${agent.userId}",${agent.totalOrders},${agent.totalQty},${agent.totalPostage.toFixed(2)},${agent.totalDiscount.toFixed(2)},${agent.totalSpinPrize.toFixed(2)},${agent.totalPrice.toFixed(2)},${agent.totalCommission.toFixed(2)},${agent.totalSupplier.toFixed(2)},${agent.totalProfit.toFixed(2)}\n`;
    });
    
    // Create download link
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sales_commission_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}
    </script>
</body>
</html>
